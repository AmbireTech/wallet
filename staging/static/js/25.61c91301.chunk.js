(this["webpackJsonpambire-wallet"]=this["webpackJsonpambire-wallet"]||[]).push([[25],{1551:function(e,t,n){var r=n(3),s=n(177),a=n(62).ethers,i=["function isValidSignature(bytes32 hash, bytes signature) view returns (bytes4)"],c=function(){var e=s(r.mark((function e(t){var n,s,i,c,l,p,g;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.provider,s=t.signer,i=t.message,c=t.typedData,l=t.finalDigest,p=t.signature,g=t.undeployedCallback,!i){e.next=5;break}l=a.utils.hashMessage(i),e.next=13;break;case 5:if(!c){e.next=11;break}if(c.domain&&c.types&&c.message){e.next=8;break}throw Error("Missing one or more properties for typedData (domain, types, message)");case 8:l=a.utils._TypedDataEncoder.hash(c.domain,c.types,c.message),e.next=13;break;case 11:if(l){e.next=13;break}throw Error("Missing one of the properties: message, unPrefixedMessage, typedData or finalDigest");case 13:if(!u(o(l,p),s)){e.next=15;break}return e.abrupt("return",!0);case 15:return e.next=17,d(n,s,l,p);case 17:if(e.t0=e.sent,"0x1626ba7e"!==e.t0){e.next=20;break}return e.abrupt("return",!0);case 20:if(!g){e.next=29;break}if(e.prev=21,!g(s,l,p)){e.next=24;break}return e.abrupt("return",!0);case 24:e.next=29;break;case 26:throw e.prev=26,e.t1=e.catch(21),new Error("undeployedCallback error: "+e.t1.message);case 29:return e.abrupt("return",!1);case 30:case"end":return e.stop()}}),e,null,[[21,26]])})));return function(t){return e.apply(this,arguments)}}(),o=function(e,t){try{return a.utils.recoverAddress(e,t)}catch(n){return!1}},u=function(e,t){if(!1===e)return!1;if(!a.utils.isAddress(e))throw new Error("Invalid recovered address: "+e);return e.toLowerCase()===t.toLowerCase()},d=function(){var e=s(r.mark((function e(t,n,s,c){var o,u,d;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=a.providers.Provider.isProvider(t)?t:new a.providers.Web3Provider(t),e.next=3,o.getCode(n);case 3:if(!(u=e.sent)||"0x"===u){e.next=7;break}return d=new a.Contract(n,i,o),e.abrupt("return",d.isValidSignature(s,c));case 7:return e.abrupt("return",!1);case 8:case"end":return e.stop()}}),e)})));return function(t,n,r,s){return e.apply(this,arguments)}}();e.exports={verifyMessage:c}},1552:function(e,t,n){},1630:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return T}));var r=n(8),s=n(3),a=n.n(s),i=n(12),c=n(9),o=n(15),u=n(567),d=n(106),l=n(21),p=n(2),g=n(1551),b=n(146),j=n(74),h=n(51),v=n(215);function f(e){return Object(l.isHexString)(e)?Object(l.arrayify)(e):Object(l.toUtf8Bytes)(e)}var x=function(e){var t,n,r=e.fetch,s=e.account,x=e.everythingToSign,m=e.relayerURL,O=e.addToast,y=e.resolve,k=e.onConfirmationCodeRequired,w=e.onLastMessageSign,S=e.getHardwareWallet,N=e.useStorage,I=Object(p.useState)(!1),A=Object(c.a)(I,2),T=A[0],D=A[1],E=Object(p.useState)(null),C=Object(c.a)(E,2),M=C[0],q=C[1],P=Object(p.useState)(null),R=Object(c.a)(P,2),L=R[0],U=R[1],V=Object(p.useState)(null),J=Object(c.a)(V,2),_=J[0],B=J[1],F=Object(p.useState)(null),W=Object(c.a)(F,2),Y=W[0],z=W[1],H=Object(p.useMemo)((function(){return x[0]||{}}),[x]),G=N({key:"signedMessages",defaultValue:[]}),K=Object(c.a)(G,2),Q=K[0],X=K[1],Z=H.dapp,$=H.chainId,ee=-1!==["eth_signTypedData_v4","eth_signTypedData"].indexOf(null===H||void 0===H?void 0:H.type);if(ee){n=H.txn;try{n.startsWith("{")&&(n=JSON.parse(H.txn))}catch(he){n=H.txn}if("object"===typeof n&&null!==n)try{var te,ne,re,se,ae,ie,ce,oe;if(null===(te=n)||void 0===te||null===(ne=te.types)||void 0===ne?void 0:ne.EIP712Domain)null===(ie=n)||void 0===ie||(null===(ce=ie.types)||void 0===ce||delete ce.EIP712Domain);if(l._TypedDataEncoder.hash(null===(re=n)||void 0===re?void 0:re.domain,n.types,null===(se=n)||void 0===se?void 0:se.message),null===(ae=n.domain)||void 0===ae?void 0:ae.chainId)$=null===(oe=n.domain)||void 0===oe?void 0:oe.chainId}catch(ve){t=".txn has Invalid TypedData object. Should be {domain, types, message}"}else t=".txn should be a TypedData object"}var ue,de=(ue=$)?h.b.find((function(e){return e.chainId===parseInt(ue.toString(),10)})):null,le=Object(p.useCallback)(Object(i.a)(a.a.mark((function e(){var t,n,i,c,o,d,p,g,h,f,x,m,O,y;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(de){e.next=2;break}return e.abrupt("return");case 2:return i=new u.Bundle({network:null===de||void 0===de?void 0:de.id,identity:null===s||void 0===s?void 0:s.id,signer:null===s||void 0===s?void 0:s.signer}),e.next=5,Object(v.a)(null===de||void 0===de?void 0:de.id);case 5:c=e.sent,(null===s||void 0===s||null===(t=s.signer)||void 0===t?void 0:t.quickAccManager)?(f=b.a.quickAccTimelock,x=[f,null===s||void 0===s||null===(p=s.signer)||void 0===p?void 0:p.one,null===s||void 0===s||null===(g=s.signer)||void 0===g?void 0:g.two],m=new l.AbiCoder,d=Object(l.keccak256)(m.encode(["tuple(uint, address, address)"],[x])),o=null===(h=s.signer)||void 0===h?void 0:h.quickAccManager):o=null===(O=s.signer)||void 0===O?void 0:O.address,y={method:"eth_call",params:[{to:i.identity,data:"0xc066a5b1000000000000000000000000".concat(o.toLowerCase().substring(2))},"latest"],id:1,jsonrpc:"2.0"},Object(j.b)(r,null===c||void 0===c||null===(n=c.connection)||void 0===n?void 0:n.url,y).then((function(e){var t;e.result&&"0x"!==e.result?(q(!0),(null===s||void 0===s||null===(t=s.signer)||void 0===t?void 0:t.quickAccManager)?U(e.result===d):"0x0000000000000000000000000000000000000000000000000000000000000001"===e.result?U(!0):U(!1)):q(!1)})).catch((function(e){B(e.message)}));case 9:case"end":return e.stop()}}),e)}))),[s,de,r]);Object(p.useEffect)((function(){le()}),[le]);var pe=Object(p.useCallback)((function(e){var t;e&&e.message.includes("must provide an Ethereum address")?O("Signing error: not connected with the correct address. Make sure you're connected with ".concat(null===(t=s.signer)||void 0===t?void 0:t.address,"."),{error:!0}):O("Signing error: ".concat(e.message||e),{error:!0})}),[s,O]),ge=Object(p.useCallback)((function(e,t,r){var a=Object(v.a)(r);return Object(g.verifyMessage)({provider:a,signer:s.id,message:ee?null:f(e.txn),typedData:ee?n:null,signature:t}).then((function(t){t?O("".concat(e.type," SIGNATURE VALID")):O("".concat(e.type," SIGNATURE INVALID"),{error:!0})})).catch((function(t){O("".concat(e.type," SIGNATURE INVALID: ").concat(t.message),{error:!0})}))}),[s,O,n,ee]),be=Object(p.useCallback)(function(){var e=Object(i.a)(a.a.mark((function e(t){var i,c,l,p,g,b,h,v;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(m){e.next=3;break}return O("Email/pass accounts not supported without a relayer connection",{error:!0}),e.abrupt("return");case 3:if(t.password){e.next=6;break}return O("Password required to unlock the account",{error:!0}),e.abrupt("return");case 6:return D(!0),e.prev=7,e.next=10,Object(j.b)(r,"".concat(m,"/second-key/").concat(s.id,"/ethereum/sign").concat(ee?"?typedData=true":""),{toSign:H.txn,code:(null===(i=t.code)||void 0===i?void 0:i.length)?t.code:void 0});case 10:if(c=e.sent,l=c.signature,p=c.success,g=c.message,b=c.confCodeRequired,p){e.next=24;break}if(D(!1),g){e.next=19;break}throw new Error("Secondary key: no success but no error message");case 19:return g.includes("invalid confirmation code")&&O("Unable to sign: wrong confirmation code",{error:!0}),O("Second signature error: ".concat(g),{error:!0}),z(null),D(!1),e.abrupt("return");case 24:if(!b){e.next=31;break}if(z(b),!k){e.next=29;break}return e.next=29,k(b,be);case 29:return D(!1),e.abrupt("return");case 31:if(s.primaryKeyBackup){e.next=33;break}throw new Error("No key backup found: you need to import the account from JSON or login again.");case 33:return e.next=35,d.Wallet.fromEncryptedJson(JSON.parse(s.primaryKeyBackup),t.password);case 35:return h=e.sent,e.next=38,ee?Object(u.signMessage712)(h,s.id,s.signer,n.domain,n.types,n.message,l):Object(u.signMessage)(h,s.id,s.signer,f(H.txn),l);case 38:return v=e.sent,e.next=41,ge(H,v,null===de||void 0===de?void 0:de.id);case 41:O("Successfully signed!"),X([].concat(Object(o.a)(Q),[{accountId:s.id,networkId:$,date:(new Date).getTime(),typed:ee,signer:s.signer,message:H.txn,signature:v,dApp:Z}])),1===x.length&&w&&w(),y({success:!0,result:v}),e.next=50;break;case 47:e.prev=47,e.t0=e.catch(7),pe(e.t0);case 50:D(!1);case 51:case"end":return e.stop()}}),e,null,[[7,47]])})));return function(t){return e.apply(this,arguments)}}(),[s,O,n,x,r,pe,ee,k,w,m,de,y,H,ge,Z,$,X,Q]),je=Object(p.useCallback)(function(){var e=Object(i.a)(a.a.mark((function e(t,r){var i,c,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(null===(i=s.signer)||void 0===i?void 0:i.quickAccManager)){e.next=4;break}return e.next=3,be(t);case 3:return e.abrupt("return");case 4:return D(!0),e.prev=5,e.next=8,S(r);case 8:if(c=e.sent){e.next=11;break}return e.abrupt("return");case 11:return e.next=13,ee?Object(u.signMessage712)(c,s.id,s.signer,n.domain,n.types,n.message):Object(u.signMessage)(c,s.id,s.signer,f(H.txn));case 13:return d=e.sent,e.next=16,ge(H,d,null===de||void 0===de?void 0:de.id);case 16:O("Successfully signed!"),X([].concat(Object(o.a)(Q),[{accountId:s.id,networkId:$,date:(new Date).getTime(),typed:ee,signer:s.signer,message:H.txn,signature:d,dApp:Z}])),y({success:!0,result:d}),e.next=24;break;case 21:e.prev=21,e.t0=e.catch(5),pe(e.t0);case 24:D(!1);case 25:case"end":return e.stop()}}),e,null,[[5,21]])})));return function(t,n){return e.apply(this,arguments)}}(),[s,O,be,n,S,pe,null===de||void 0===de?void 0:de.id,y,H,ee,ge,Q,X,Z,$]);return{approve:je,approveQuickAcc:be,toSign:H,isLoading:T,hasPrivileges:L,hasProviderError:_,typeDataErr:t,isDeployed:M,dataV4:n,requestedNetwork:de,requestedChainId:$,isTypedData:ee,confirmationType:Y,verifySignature:ge,dApp:Z}},m=x,O=["https://snapshot.org","https://guild.xyz","https://sudoswap.xyz","https://evm-sigtools.ambire.com","https://app.swappin.gifts","https://staging.swappin.gifts/ref/ambire"],y=(n(1552),n(48)),k=n(212),w=n(531),S=n(46),N=n(85),I=n(214),A=n(4);function T(e){var t=e.everythingToSign,n=e.resolve,s=e.account,o=e.relayerURL,u=e.totalRequests,d=Object(S.a)().addToast,l=Object(p.useState)({codeRequired:!1,passphrase:""}),g=Object(c.a)(l,2),b=g[0],j=g[1],h=Object(p.useState)(null),v=Object(c.a)(h,2),f=v[0],x=v[1],T=Object(p.useRef)(null),E=function(){var e=Object(i.a)(a.a.mark((function e(t,n){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){x((function(){return e}))}));case 2:if(r=e.sent){e.next=5;break}throw new Error("You must enter a confirmation code");case 5:return e.next=7,n({password:b.passphrase,code:r});case 7:return e.abrupt("return");case 8:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),C=m({fetch:fetch,account:s,everythingToSign:t,relayerURL:o,addToast:d,resolve:n,onConfirmationCodeRequired:E,getHardwareWallet:function(){return Object(w.a)({signer:s.signer,signerExtra:s.signerExtra,chainId:1})},useStorage:I.a}),M=C.approve,q=C.toSign,P=C.isLoading,R=C.hasPrivileges,L=C.hasProviderError,U=C.typeDataErr,V=C.isDeployed,J=C.dataV4,_=C.requestedNetwork,B=C.requestedChainId,F=C.isTypedData,W=C.confirmationType,Y=C.dApp,z=Y&&O.includes(Y.url);if(Object(p.useEffect)((function(){W&&T.current.focus()}),[W]),!q||!s)return Object(A.jsx)(A.Fragment,{});if(!_)return Object(A.jsxs)("div",{id:"signMessage",children:[Object(A.jsxs)("h3",{className:"error",children:["Inexistant network for chainId : ",B]}),Object(A.jsx)(N.e,{className:"reject",onClick:function(){return n({message:"signature denied"})},children:"Reject"})]});if(U)return Object(A.jsxs)("div",{id:"signMessage",children:[Object(A.jsxs)("h3",{className:"error",children:["Invalid signing request: ",U]}),Object(A.jsx)(N.e,{className:"reject",onClick:function(){return n({message:"signature denied"})},children:"Reject"})]});return Object(A.jsxs)("div",{id:"signMessage",children:[Object(A.jsxs)("div",{id:"signingAccount",className:"panel",children:[Object(A.jsx)("div",{className:"title",children:"Signing with account"}),Object(A.jsxs)("div",{className:"content",children:[Object(A.jsxs)("div",{className:"signingAccount-account",children:[Object(A.jsx)("img",{className:"icon",src:k.create({seed:s.id}).toDataURL(),alt:"Account Icon"}),s.id]}),Object(A.jsxs)("div",{className:"signingAccount-network",children:["on",Object(A.jsx)("div",{className:"icon",style:{backgroundImage:"url(".concat(_.icon,")")}}),Object(A.jsx)("div",{className:"address",children:_.name})]})]})]}),Object(A.jsxs)("div",{className:"panel",children:[Object(A.jsxs)("div",{className:"title signMessageTitle",children:[Object(A.jsx)("span",{className:"signMessageTitle-title",children:"Sign message"}),Object(A.jsx)("span",{className:"signMessageTitle-signatureType",children:Object(A.jsxs)(N.B,{label:"".concat(F?"An EIP-712 typed data signature has been requested":"An ethSign ethereum signature type has been requested"),children:[Object(A.jsx)(y.o,{})," ",Object(A.jsx)("span",{children:F?"EIP-712 type":"standard type"})]})})]}),Object(A.jsxs)("div",{className:"request-message",children:[Object(A.jsxs)("div",{className:"dapp-message",children:[Y?Object(A.jsxs)("a",{className:"dapp",href:Y.url,target:"_blank",rel:"noreferrer",children:[Object(A.jsx)("div",{className:"icon",style:{backgroundImage:"url(".concat(Y.icons?Y.icons[0]:"none",")")},children:Object(A.jsx)(y.a,{})}),Y.name]}):"A dApp ","is requesting your signature."]}),Object(A.jsx)("span",{children:u>1?"You have ".concat(u-1," more pending requests."):""}),!z&&Object(A.jsx)(N.i,{})]}),Object(A.jsx)("textarea",{className:"sign-message",type:"text",value:J?JSON.stringify(J,"\n"," "):"0x"!==q.txn?D(q.txn):"(Empty message)",readOnly:!0}),Object(A.jsx)("div",{className:"actions",children:Object(A.jsxs)("form",{onSubmit:function(e){e.preventDefault(),M({password:b.passphrase})},children:[s.signer.quickAccManager&&V&&Object(A.jsxs)(A.Fragment,{children:[Object(A.jsx)(N.z,{password:!0,required:!0,minLength:3,placeholder:"Account password",value:b.passphrase,onChange:function(e){return j(Object(r.a)(Object(r.a)({},b),{},{passphrase:e}))}}),Object(A.jsx)("input",{type:"submit",hidden:!0})]}),W&&Object(A.jsxs)(A.Fragment,{children:["email"===W&&Object(A.jsx)("span",{children:"A confirmation code has been sent to your email, it is valid for 3 minutes."}),"otp"===W&&Object(A.jsx)("span",{children:"Please enter your OTP code"}),Object(A.jsx)(N.z,{ref:T,placeholder:"otp"===W?"Authenticator OTP code":"Confirmation code",onInput:function(e){var t;6===(t=e).length&&f(t)}})]}),null===V&&!L&&Object(A.jsx)("div",{children:Object(A.jsx)(N.n,{})}),!1===V&&Object(A.jsxs)("div",{children:[Object(A.jsx)("h3",{className:"error",children:"You can't sign this message yet."}),Object(A.jsxs)("h3",{className:"error",children:["You need to complete your first transaction on"," ",_.name," network in order to be able to sign messages."]})]}),!1===R&&Object(A.jsx)("div",{children:Object(A.jsx)("h3",{className:"error",children:"You do not have the privileges to sign this message."})}),L&&Object(A.jsx)("div",{children:Object(A.jsxs)("h3",{className:"error",children:["There was an issue with the network provider:"," ",L]})}),Object(A.jsxs)("div",{className:"buttons",children:[Object(A.jsx)(N.e,{type:"button",danger:!0,icon:Object(A.jsx)(y.f,{}),className:"reject",onClick:function(){return n({message:"signature denied"})},children:"Reject"}),null!==V&&V&&R&&Object(A.jsx)(N.e,{type:"submit",className:"approve",disabled:P,children:P?Object(A.jsxs)(A.Fragment,{children:[Object(A.jsx)(N.n,{}),"Signing..."]}):Object(A.jsxs)(A.Fragment,{children:[Object(A.jsx)(y.d,{})," Sign"]})})]})]})})]})]})}function D(e){if(Object(l.isHexString)(e))try{return Object(l.toUtf8String)(e)}catch(t){return e}return(null===e||void 0===e?void 0:e.toString)?e.toString():e+""}},585:function(e,t){}}]);
//# sourceMappingURL=25.61c91301.chunk.js.map